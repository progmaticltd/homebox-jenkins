upstream jenkins {
    server 127.0.0.1:8080 fail_timeout=0;
}


server {
    listen 443 ssl;
    server_name jenkins.{{ network.domain }};

    ssl_certificate /etc/letsencrypt/live/jenkins.{{ network.domain }}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/jenkins.{{ network.domain }}/privkey.pem;

    # HSTS for better security
    add_header Strict-Transport-Security "max-age=31536000;" always;

    ignore_invalid_headers off;

    # Remove useless tokens for better security feelings ;-)
    server_tokens off;

    location / {

        proxy_set_header        Host $host:$server_port;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;

        proxy_redirect          http:// https://;
        proxy_pass              http://jenkins;

        # Make sure CSRF is handled properly
        proxy_set_header        Upgrade         $http_upgrade;
        proxy_pass_header       Set-Cookie;

        # Required for new HTTP-based CLI
        proxy_http_version 1.1;
        proxy_request_buffering off;
        proxy_buffering off; # Required for HTTP-based CLI to work over SSL

        # Workaround for https://issues.jenkins-ci.org/browse/JENKINS-45651
        # add_header 'X-SSH-Endpoint' 'jenkins.{{ network.domain }}:50022' always;

        limit_except GET {
            allow 92.19.253.41;     # myself
            allow 140.82.112.0/20;  # github
            deny all;
        }
    }

    # Ajax executors & build queue
    location /ajaxExecutors {
        proxy_set_header        Host $host:$server_port;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;

        proxy_redirect          http:// https://;
        proxy_pass              http://jenkins;

        # Required for new HTTP-based CLI
        proxy_http_version 1.1;
        proxy_request_buffering off;
        proxy_buffering off; # Required for HTTP-based CLI to work over SSL

        # Workaround for https://issues.jenkins-ci.org/browse/JENKINS-45651
        # add_header 'X-SSH-Endpoint' 'jenkins.{{ network.domain }}:50022' always;

        allow all;
    }
    location /ajaxBuildQueue {
        proxy_set_header        Host $host:$server_port;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;

        proxy_redirect          http:// https://;
        proxy_pass              http://jenkins;

        # Required for new HTTP-based CLI
        proxy_http_version 1.1;
        proxy_request_buffering off;
        proxy_buffering off; # Required for HTTP-based CLI to work over SSL

        # Workaround for https://issues.jenkins-ci.org/browse/JENKINS-45651
        # add_header 'X-SSH-Endpoint' 'jenkins.{{ network.domain }}:50022' always;

        allow all;
    }

    # Serve downloaded files over https
    location /theme/ {
        alias /var/lib/jenkins/download-themes/;
    }

    # ISO images downloads
    location /downloads {
        return 301 "/downloads/";
    }

    location /downloads/ {
        alias /var/lib/jenkins/downloads/;

        fancyindex on;
        fancyindex_exact_size off;  # Output human-readable file sizes.

        # Specify the path to the header.html and foother.html files, that are server-wise,
        # ie served from root of the website. Remove the leading '/' otherwise.
        fancyindex_header "/theme/light/header.html";
        fancyindex_footer "/theme/light/footer.html";

        # Maximum file name length in bytes, change as you like.
        # Warning: if you use an old version of ngx-fancyindex, comment the last line if you
        # encounter a bug. See https://github.com/Naereen/Nginx-Fancyindex-Theme/issues/10
        fancyindex_name_length 255;
    }

    # log files per virtual host
    access_log /var/log/nginx/jenkins-access.log;
    error_log /var/log/nginx/jenkins-error.log;
}
